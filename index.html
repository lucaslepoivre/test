<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carte OSM - Clusters + panneau</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: 100vh; width: 100vw; }

    /* Panneau latéral */
    #sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 320px;
      max-width: 85vw;
      height: 100vh;
      background: #fff;
      box-shadow: -8px 0 20px rgba(0,0,0,0.12);
      padding: 14px 14px 10px;
      z-index: 9999;
      overflow: auto;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #sidebar h2 {
      margin: 0 0 6px 0;
      font-size: 16px;
    }

    #sidebar .meta {
      font-size: 13px;
      color: #444;
      margin-bottom: 10px;
    }

    #sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    #sidebar li {
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      cursor: pointer;
    }

    #sidebar li:hover {
      background: #fafafa;
    }

    #sidebar .small {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }

    /* Bouton toggle */
    #toggleSidebar {
      position: fixed;
      top: 12px;
      right: 332px;
      z-index: 10000;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      box-shadow: 0 6px 16px rgba(0,0,0,0.10);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    /* État fermé */
    .sidebar-hidden #sidebar { display: none; }
    .sidebar-hidden #toggleSidebar { right: 12px; }

    /* Cluster look (optionnel : rend les cercles plus “bulle”) */
    .marker-cluster div {
      border-radius: 999px !important;
    }
  </style>
</head>
<body>
  <button id="toggleSidebar" type="button">Masquer la liste</button>

  <div id="sidebar">
    <h2>Points dans le cercle</h2>
    <div class="meta" id="sidebarMeta">Clique sur un point pour afficher la liste.</div>
    <ul id="sidebarList"></ul>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet MarkerCluster JS -->
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    const map = L.map('map').setView([47.18, -1.42], 11);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Points avec type a ou b
    const points = [
      { lat:47.194285, lon:-1.423073, type:"a" },
      { lat:47.194285, lon:-1.423073, type:"b" },
      { lat:47.185983, lon:-1.443629, type:"a" },
      { lat:47.168604, lon:-1.437149, type:"b" },
      { lat:47.168604, lon:-1.437149, type:"a" },
      { lat:47.182145, lon:-1.417429, type:"b" },
      { lat:47.161925, lon:-1.408482, type:"a" },
      { lat:47.194832, lon:-1.342392, type:"b" },
      { lat:47.125479, lon:-1.420670, type:"a" },
      { lat:47.139500, lon:-1.338272, type:"b" }
    ];

    // Sidebar elements
    const sidebarMeta = document.getElementById("sidebarMeta");
    const sidebarList = document.getElementById("sidebarList");

    // Toggle sidebar
    const toggleBtn = document.getElementById("toggleSidebar");
    toggleBtn.addEventListener("click", () => {
      document.body.classList.toggle("sidebar-hidden");
      toggleBtn.textContent = document.body.classList.contains("sidebar-hidden")
        ? "Afficher la liste"
        : "Masquer la liste";
      // Important: Leaflet doit recalculer la taille si on change l’UI
      setTimeout(() => map.invalidateSize(), 0);
    });

    // Icônes
    const defaultIcon = new L.Icon.Default();
    const greenIcon = new L.Icon({
      iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png",
      shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
      iconSize: [25,41],
      iconAnchor: [12,41],
      popupAnchor: [1,-34],
      shadowSize: [41,41]
    });

    // Distance haversine en mètres
    function distance(lat1, lon1, lat2, lon2) {
      const R = 6371000;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function renderSidebar(centerPoint, radius, insideItems) {
      const km = (radius/1000).toFixed(0);
      sidebarMeta.innerHTML = `
        Centre : ${centerPoint.lat.toFixed(6)}, ${centerPoint.lon.toFixed(6)} ·
        Rayon : ${km} km ·
        Points : <b>${insideItems.length}</b>
      `;

      sidebarList.innerHTML = "";

      if (insideItems.length === 0) {
        const li = document.createElement("li");
        li.textContent = "Aucun point dans le cercle.";
        sidebarList.appendChild(li);
        return;
      }

      insideItems.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `
          <b>TEST (${item.data.type})</b>
          <div class="small">${item.data.lat.toFixed(6)}, ${item.data.lon.toFixed(6)} · ${Math.round(item.d)} m</div>
        `;

        li.addEventListener("click", () => {
          map.setView([item.data.lat, item.data.lon], 14);
          item.marker.openPopup();
        });

        sidebarList.appendChild(li);
      });
    }

    let activeCircle = null;

    // --- CLUSTER LAYER (bulles avec nombre au dézoom)
    const clusters = L.markerClusterGroup({
      // Optionnel: personnaliser l’icône du cluster
      iconCreateFunction: function (cluster) {
        const count = cluster.getChildCount();
        // petite / moyenne / grande classe (MarkerCluster.Default.css s’en sert)
        let c = ' marker-cluster-';
        if (count < 10) c += 'small';
        else if (count < 50) c += 'medium';
        else c += 'large';

        return L.divIcon({
          html: `<div><span>${count}</span></div>`,
          className: 'marker-cluster' + c,
          iconSize: L.point(40, 40)
        });
      }
    });

    // On garde tout en mémoire pour calculer “dans le cercle”
    const markerObjects = []; // { marker, data }

    points.forEach(p => {
      const marker = L.marker([p.lat, p.lon], { icon: defaultIcon });
      marker.bindPopup(`<h3>TEST (${p.type})</h3>`);

      marker.on("click", () => {
        // Supprimer ancien cercle
        if (activeCircle) {
          map.removeLayer(activeCircle);
          activeCircle = null;
        }

        // Reset icônes
        markerObjects.forEach(o => o.marker.setIcon(defaultIcon));

        // Rayon selon type
        const radius = (p.type === "a") ? 10000 : 20000;

        // Nouveau cercle
        activeCircle = L.circle([p.lat, p.lon], {
          radius,
          color: "red",
          weight: 2,
          fillColor: "red",
          fillOpacity: 0.15
        }).addTo(map);

        map.fitBounds(activeCircle.getBounds());

        // Mettre en vert + remplir la liste
        const inside = [];
        markerObjects.forEach(o => {
          const ll = o.marker.getLatLng();
          const d = distance(p.lat, p.lon, ll.lat, ll.lng);
          if (d <= radius) {
            o.marker.setIcon(greenIcon);
            inside.push({ marker: o.marker, data: o.data, d });
          }
        });

        inside.sort((a, b) => a.d - b.d);
        renderSidebar(p, radius, inside);
      });

      clusters.addLayer(marker);
      markerObjects.push({ marker, data: p });
    });

    map.addLayer(clusters);

    // Vue initiale sur tout
    const group = L.featureGroup(markerObjects.map(o => o.marker));
    map.fitBounds(group.getBounds().pad(0.2));

    // Optionnel : si on clique sur la carte (pas un marker), on enlève le cercle + reset
    map.on('click', (e) => {
      // ignore si c’est un clic sur un cluster/marker (Leaflet gère mais on reste safe)
      if (activeCircle) {
        map.removeLayer(activeCircle);
        activeCircle = null;
        markerObjects.forEach(o => o.marker.setIcon(defaultIcon));
        sidebarMeta.textContent = "Clique sur un point pour afficher la liste.";
        sidebarList.innerHTML = "";
      }
    });
  </script>
</body>
</html>
